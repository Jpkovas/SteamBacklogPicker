name: CI Build and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  common-suite:
    name: Common suite (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore SteamBacklogPicker.sln

      - name: Build common projects
        shell: bash
        run: |
          set -euo pipefail
          dotnet build src/Domain/Domain.csproj -c Release --no-restore -f net8.0
          dotnet build src/Integration/ValveFormatParser/ValveFormatParser.csproj -c Release --no-restore -f net8.0
          dotnet build src/Integration/SteamClientAdapter/SteamClientAdapter.csproj -c Release --no-restore -f net8.0
          dotnet build src/Integration/SteamHooks/SteamHooks.csproj -c Release --no-restore -f net8.0
          dotnet build src/Infrastructure/Telemetry/Telemetry.csproj -c Release --no-restore -f net8.0
          dotnet build src/Infrastructure/SteamDiscovery/SteamDiscovery.csproj -c Release --no-restore -f net8.0
          dotnet build src/Presentation/SteamBacklogPicker.AppCore/SteamBacklogPicker.AppCore.csproj -c Release --no-restore -f net8.0
          dotnet build src/Presentation/SteamBacklogPicker.Linux/SteamBacklogPicker.Linux.csproj -c Release --no-restore -f net8.0

      - name: Run common tests
        shell: bash
        run: |
          set -euo pipefail
          dotnet test tests/Domain/Domain.Tests/Domain.Tests.csproj -c Release --no-restore -f net8.0 --logger "trx;LogFileName=Domain.Tests.${{ runner.os }}.trx" --results-directory ./TestResults
          dotnet test tests/Integration/SteamClientAdapter.Tests/SteamClientAdapter.Tests.csproj -c Release --no-restore -f net8.0 --logger "trx;LogFileName=SteamClientAdapter.Tests.${{ runner.os }}.trx" --results-directory ./TestResults
          dotnet test tests/Integration/SteamHooks.Tests/SteamHooks.Tests.csproj -c Release --no-restore -f net8.0 --logger "trx;LogFileName=SteamHooks.Tests.${{ runner.os }}.trx" --results-directory ./TestResults
          dotnet test tests/Infrastructure/SteamDiscovery.Tests/SteamDiscovery.Tests.csproj -c Release --no-restore -f net8.0 --logger "trx;LogFileName=SteamDiscovery.Tests.${{ runner.os }}.trx" --results-directory ./TestResults
          dotnet test tests/Presentation/SteamBacklogPicker.Linux.Tests/SteamBacklogPicker.Linux.Tests.csproj -c Release --no-restore -f net8.0 --logger "trx;LogFileName=SteamBacklogPicker.Linux.Tests.${{ runner.os }}.trx" --results-directory ./TestResults

      - name: Upload common test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-common-${{ runner.os }}
          path: TestResults/**/*.trx
          retention-days: 30

  windows-suite:
    name: Windows-only suite
    runs-on: windows-latest
    needs: common-suite
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore SteamBacklogPicker.sln

      - name: Build Windows projects
        shell: bash
        run: |
          set -euo pipefail
          dotnet build src/Infrastructure/SteamDiscovery/SteamDiscovery.csproj -c Release --no-restore -f net8.0-windows10.0.17763.0
          dotnet build src/Presentation/SteamBacklogPicker.UI/SteamBacklogPicker.UI.csproj -c Release --no-restore -f net8.0-windows10.0.18362.0

      - name: Run Windows-only tests
        shell: bash
        run: |
          set -euo pipefail
          dotnet test tests/Infrastructure/SteamDiscovery.Tests/SteamDiscovery.Tests.csproj -c Release --no-restore -f net8.0-windows10.0.17763.0 --logger "trx;LogFileName=SteamDiscovery.Tests.WindowsOnly.trx" --results-directory ./TestResults
          dotnet test tests/Presentation/SteamBacklogPicker.UI.Tests/SteamBacklogPicker.UI.Tests.csproj -c Release --no-restore -f net8.0-windows10.0.18362.0 --logger "trx;LogFileName=SteamBacklogPicker.UI.Tests.WindowsOnly.trx" --results-directory ./TestResults

      - name: Upload Windows-only test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-windows-only
          path: TestResults/**/*.trx
          retention-days: 30

  test-parity-report:
    name: Publish test parity report
    runs-on: ubuntu-latest
    needs: [common-suite, windows-suite]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate parity report by layer
        run: |
          cat > docs/testing/test-parity-report.md <<'REPORT'
          # Test parity report by layer

          | Layer | Linux (common suite) | Windows (common suite) | Windows-only suite |
          | --- | --- | --- | --- |
          | Domain | `Domain.Tests` | `Domain.Tests` | N/A |
          | Infrastructure | `SteamDiscovery.Tests` (`net8.0`) | `SteamDiscovery.Tests` (`net8.0`) | `SteamDiscovery.Tests` (`net8.0-windows10.0.17763.0`) |
          | Integration | `SteamClientAdapter.Tests`, `SteamHooks.Tests` | `SteamClientAdapter.Tests`, `SteamHooks.Tests` | N/A |
          | Presentation | `SteamBacklogPicker.Linux.Tests` | `SteamBacklogPicker.Linux.Tests` | `SteamBacklogPicker.UI.Tests` (`net8.0-windows10.0.18362.0`) |

          Este relatório garante visibilidade explícita de cobertura por sistema operacional e ajuda a prevenir regressões de paridade entre Linux e Windows na esteira de CI.
          REPORT

      - name: Upload parity report
        uses: actions/upload-artifact@v4
        with:
          name: test-parity-report
          path: docs/testing/test-parity-report.md
          retention-days: 30

  build-artifacts:
    name: Build Release Artifacts
    runs-on: windows-latest
    timeout-minutes: 10
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [common-suite, windows-suite]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore and build
      run: |
        dotnet restore SteamBacklogPicker.sln
        dotnet build src/Presentation/SteamBacklogPicker.UI/SteamBacklogPicker.UI.csproj --configuration Release --no-restore --framework net8.0-windows10.0.18362.0

    - name: Publish application
      run: |
        dotnet publish src/Presentation/SteamBacklogPicker.UI/SteamBacklogPicker.UI.csproj `
          --configuration Release `
          --no-build `
          --framework net8.0-windows10.0.18362.0 `
          --output ./publish

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: steambacklogpicker-release
        path: publish/
        retention-days: 7
